version: "3.8"

services:
  # ============================================
  # TRAEFIK - Reverse Proxy
  # ============================================
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    
    # Garantir que rode como root com GID do docker (1001)
    user: "0:1001"
    
    command:
      # API e Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=true"
      
      # Logs
      - "--log.level=DEBUG"
      - "--accesslog=true"
      
      # Providers
      - "--providers.docker=true"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=laboratorio-network"
      - "--providers.docker.watch=true"
      
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # Certificados SSL
      #- "--certificatesresolvers.letsencrypt.acme.email=rafael_junio_moraes@hotmail.com"
      #- "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      #- "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      #- "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      
      # Ping
      - "--ping=true"
      - "--ping.entrypoint=web"
    
    ports:
      - "127.0.0.1:80:80"
      - "127.0.0.1:443:443"
      - "127.0.0.1:8080:8080"
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - traefik-certificates:/letsencrypt
    
    networks:
      - laboratorio-network
    
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.rflgx.com.br`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"

  # ============================================
  # MYSQL Database
  # ============================================
  db:
    image: mysql:8.0
    container_name: mysql-nest-lab
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - mysql_lab_data:/var/lib/mysql
    ports:
      - "127.0.0.1:3306:3306"
    networks:
      - laboratorio-network
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test:
        ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # MySQL Backup
  # ============================================
  backup:
    image: fradelg/mysql-cron-backup:latest
    container_name: mysql-backup-lab
    restart: unless-stopped
    environment:
      - MYSQL_HOST=db
      - MYSQL_PORT=${MYSQL_PORT}
      - MYSQL_USER=root
      - MYSQL_PASS=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - CRON_TIME=0 2 * * *
      - MAX_BACKUPS=10
      - INIT_BACKUP=1
      - GZIP_LEVEL=9
      - TIMEOUT=10m
    volumes:
      - ./backups:/backup
    networks:
      - laboratorio-network
    depends_on:
      db:
        condition: service_healthy

  # ============================================
  # NestJS API
  # ============================================
  api:
    container_name: nest-lab-api
    image: xrafaelgx/nest-lab-api:latest
    restart: unless-stopped
    environment:
      - TZ=UTC
      - NODE_ENV=${XNODE_ENV}
      - PORT=${PORT}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_TOKEN_AUDIENCE=${JWT_TOKEN_AUDIENCE}
      - JWT_TOKEN_ISSUER=${JWT_TOKEN_ISSUER}
      - JWT_TTL=${JWT_TTL}
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_USER=${MAIL_USER}
      - MAIL_PASS=${MAIL_PASS}
      - MAIL_FROM=${MAIL_FROM}
    networks:
      - laboratorio-network
    depends_on:
      db:
        condition: service_healthy

    labels:
      - "traefik.enable=true"

      # Rota para /api/*
      - "traefik.http.routers.api.rule=Host(`rflgx.com.br`) && (PathPrefix(`/api`) || PathPrefix(`/socket.io`))"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.services.api.loadbalancer.server.port=3000"

      # Middleware rm /api path
      - "traefik.http.middlewares.api-stripprefix.stripprefix.prefixes=/api"
      - "traefik.http.routers.api.middlewares=api-stripprefix"
      
      

      # WebSocket sup
      - "traefik.http.services.api.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.api.loadbalancer.sticky.cookie.name=api_sticky"

    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 401 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Angular SSR Frontend
  # ============================================
  frontend:
    container_name: angular-lab-web
    image: xrafaelgx/angular-lab-web:latest
    restart: unless-stopped
    networks:
      - laboratorio-network
    depends_on:
      api:
        condition: service_healthy

    labels:
      - "traefik.enable=true"
      
      - "traefik.http.routers.frontend.rule=Host(`rflgx.com.br`)"


      # Rota padrÃ£o
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.priority=1" # prioridade
      - "traefik.http.services.frontend.loadbalancer.server.port=4000"

      # Middleware compress
      - "traefik.http.middlewares.frontend-compress.compress=true"
      - "traefik.http.routers.frontend.middlewares=frontend-compress"

    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Cloudflare Tunnel
  # ============================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - laboratorio-network
    depends_on:
      - traefik

volumes:
  mysql_lab_data:
    driver: local
  traefik-certificates:
    driver: local

networks:
  laboratorio-network:
    driver: bridge
